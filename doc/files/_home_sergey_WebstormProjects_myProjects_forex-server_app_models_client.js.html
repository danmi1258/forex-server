<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/home/sergey/WebstormProjects/myProjects/forex-server/app/models/client.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Client.html">Client</a></li>
            
                <li><a href="../classes/Default.html">Default</a></li>
            
                <li><a href="../classes/Order.html">Order</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: /home/sergey/WebstormProjects/myProjects/forex-server/app/models/client.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var mongoose = require(&#x27;mongoose&#x27;);
var BaseSchema = require(&#x27;./base&#x27;);
var confing = require(&#x27;confing&#x27;);
var sockets = require(&#x27;../middleware/socket&#x27;);
var _ = require(&#x27;underscore&#x27;);
var Order = require(&#x27;./order&#x27;);


// !! not var. set is as global;
extend = require(&#x27;mongoose-schema-extend&#x27;);


/**
 * @class Client
 * @extends Default
 */
var Client = BaseSchema.extend({
    /* - */
    name: String,
    /* ids of a terminal-providers */
    subscriptions: Array,
    /* ids of an open orders in terminal.
        [{orderId, orderTid}, ... ],
        где:
            orderId - ссылка на ордер в БД
            orderTid - назначенный id для терминала.
        */
    openOrders: Array,
    /* the terminal access code */
    token: String,
    /* terminal id */
    tid: Number,
    /* terminal type in HEX: provider(0x01010) / consumer (0x1020) */
    type: String
});

Client.statics.getSubscribtionHash = function() {
    return {
        _id: null,
        volume: 0.01
    }
};

/* create new terminal */
Client.statics.create = function(data, callback) {
   var Terminal = this;

   if (!data.name || !data.tid || !data.type) return callback(new Error(&#x27;data error&#x27;));

   var terminal = new Terminal(data);


   terminal.save(callback);
};


/*  Сообщение через сокет
    ---------------------
    Метод отсылает сообщение через сокет на терминал. Если открытого сокета для данного терминала не найдено 
    (терминал не имеет активного соединения), вернется ошибка.
*/
Client.methods.sendMessage = function(message, callback) {
    var socket = sockets.getSocket(this.tid);
    if (!socket) callback(&#x27;socket not found&#x27;); return;
    
    sockets.server.send(socket, message);
    callback(null);
};


Client.methods.alreadySubscribed = function(provider) {
    return this.subscriptions.indexOf(provider._id) != -1;
};


/** 
    @method subscribe
    @description Пописаться  
    =======================

    Метод подписывает один терминал на другой. Подписаться можно только на терминал с типом провайдер.
    
    @param provider {object} объект терминала провайдера.
    @return {object} - instance of Order
**/
Client.methods.subscribe = function(provider, callback) {
    if (provider.type != &#x27;provider&#x27;) return callback(401);
    if (this.alreadySubscribed(provider)) return callback(401);

    this.subscriptions.push(provider._id);
    this.save(callback);
};


/** 
    @async 
    @method unsubscribe
    @description Одписаться
    =======================

    Метод отписывает терминал потребитель от терминала провайдера.
    
    @param provider {object} объект терминала провайдера
    @param callback {function}
    @return {object} - instance of Client
**/
Client.methods.unsubscribe = function(provider, callback) {
    if (!this.alreadySubscribed(provider)) return callback(401);

    this.subscriptions.splice(this.subscriptions.indexOf(provider._id));
    this.save(callback);
};

/** 
    @async
    @method changeToken
    @description Изменить токен
    ===========================
    Метод изменяет токен для текущего клиента. Токен может быть назначен только из таблицы существующих 
    токенов.
    Токен должен быть:
    
    * существующим
    * активным
    * свободным (не использованным)
    
    @param token {object}
    @param callback {function (err, token ) }
**/
Client.methods.changeToken = function(token, callback) {
    if (!!token.closed) return callback(401);

    this.token = token._id;
    this.save(callback);
};




/*  Получить все подписки.
    ---------------------
    Позволяет быстро получить все терминалы (в виде АПИ объектов) на которые подписан текущий терминал.
    */
Client.methods.getSubscribtions = function(callback) {
    this.find({subscriptions: {$in: this.subscriptions}}, callback);
};


/* юзер */
Client.methods.changeVolume = function() {};

/* юзер */
Client.methods.setPause = function() {};



/* МЕТОДЫ УПРАВЛЕНИЯ ОРДЕРАМИ
##################################
*/

var orderTypes = confing.orderTypes;

/** @async
    @method createOrder 
    @description Создать запись о новом ордере
    ==========================================
    
    Методы создает новую запись в таблице orders, привязывая его к текущему клиенту.
    Также метод делает уведомление по сокету своему терминалу с приказом об открытии нового ордера.

    sИспользуйте этот метод, когда хотите инициировать создание нового ордера со стороны сервера.

    @param values {object} - данные для создания нового ордера
    @param callback {function}
    @return {err, object} err, order
**/
Client.methods.createOrder = function(values, callback) {
    values.status = orderTypes.CREATING;
    values.client = this._id;
    
    client.sendMessage({
        type: &#x27;&#x27;, // todo определить тип сообщения
        data: {/* order values */} 
    });

    new Order(values).save(callback);

};


/*  Подтвердить создание нового ордера
    ==================================
    @descrpition
    Метод подтверждает открытие ордера в терминале.
    * Используйте этот метод, когда надо подтвердить факт, действительно ли ордер был открыт в терминале.
    
    @prop orderTime {Date} - время создания ордера в терминалом. Аналог ID
    @return {object} - объект ордера как модель Order
*/
Client.methods.confirmOrderCreation = function(orderTime, callback) {
    Order.getByTime(orderTime, function(err, order) {
        if (err) return callback(err);
        
        order.status = orderTypes.CREATED;
        order.openedOn: new Date().getTime();
        order.save(callback);
    })
};

Client.methods.closeOrder = function(orderTime) {
    Order.getByTime(orderTime, function(err, order) {
        if (err) return callback(err);

        client.sendMessage({
            type: &#x27;&#x27;, //todo определить тип сообщения
            data: {orderTime: orderTime}
        });

        order.status = orderTime.CLOSING;
        order.save(callback);
    })
};


Client.method.confirmOrderClosing = function(orderTime) {
    Order.getByTime(orderTime, function(err, order) {
        if (err) return callback(err);

        order.status = orederTime.CLOSED;
        order.closedOn = new Date().getTime();
        order.save(callback);
    });
};


/*  Получает список открытых ордеров.
    ==================================
    @return {Array} - список открытых ордеров в виде объектов модели Order

*/
Client.methods.getOpenOrders = function(callback) {
    this.find({ client: this._id, _id: {$in: this.openOrders }}, function(err, res) {
        if (err) callback(err); return;
        callback(null, res);
    })
};

/*  Проверка на наличине открытых ордеров
    -------------------------------------
*/
Client.methods.hasOpenOrders = function() {
    return !!this.openOrders.length;
};


/**  @async
    @method checkOnChange
    @description Сверить ордера
    ===========================

    Метод получает список открытых позиций и сравнивает с уже открытыми. 
    Возвращает информацию с отличиями.
    
    хэш сообщения от терминала orderList 
    ------------------------------------

        orderList = [{
        orederOpenTime,
        orderSymbol,
        orderType,
        orderProfit,
        tid,
        client   
    }]

    res: возвращаемые данные
    ------------------------

    * @property newOrders {Array} - список новых ордеров в виде объектов типа Order _[order, ...]_
    * closedOrders* {Array} - список закрытых ордеров в виде объектов типа Order _[order, ...]_
    
    @param orderList {object} see description orderList
    @param callback {function (err, res) } see res
**/
Client.methods.checkOnChange = function(orderList, callback) {
 

    //  запрос списка открытых ордеров, принадлежащих данному клиенту.
    this.getOpenOrders(function(err, orders) {
        if (err) callback(err); return;

        var ordersTIDs = _.pluck(orders, &#x27;tid&#x27;);
        var ordersListTIDs = _.pluck(orderList, &#x27;tid&#x27;);
        var newOrders = [], closedOrders = [];

        // список ордеров, которые были созданы с момента последнего обращения
        if (ordersTIDs.length){
            newOrders = _.filter(orderList, function(e) {
                return ordersTIDs.indexOf(e.tid) == -1;
            })    
        }

        // список ордеров, которые были закрыты с момента последнего обращения
        if (ordersListTIDs) {
            var closedOrders = _.filter(orders, function(e) {
                return ordersListTIDs.indexOf(e.tid) == -1; 
            })    
        }

        callback(null, {newOrders: newOrders, closedOrders: closedOrders});
    })
};


module.exports = mongoose.model(&#x27;client&#x27;, Client);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
